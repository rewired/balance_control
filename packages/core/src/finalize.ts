/* eslint-disable */
import { GameSnapshotSchema } from './protocol';import type { GameSnapshot } from './protocol';import type { EngineRegistries } from './expansion/types';import { settleRound } from './settlement';// Perform final round settlement and invoke onGameEnd hooks.// Intended to be called by server/game-engine when a terminal condition is detected.export function finalizeGame(snapshot: GameSnapshot, registries: EngineRegistries): GameSnapshot {  const at = Date.now();  const { nextState } = settleRound(snapshot.state as any);  const entry = { id: 'finalize-' + at, at, kind: 'core.finalizeGame', message: 'Final settlement at game end' };  let next: GameSnapshot = { ...snapshot, revision: snapshot.revision + 1, updatedAt: at, state: nextState as any, log: [...snapshot.log, entry] } as GameSnapshot;  const onEnd = registries.hooks.onGameEnd ?? [];  for (const h of onEnd) {    try {      // Hook may return a new snapshot-like object      const maybe = (h as any)(next);      if (maybe && typeof maybe === 'object' && 'state' in maybe) {        next = GameSnapshotSchema.parse(maybe) as GameSnapshot;      }    } catch {      // ignore hook failures during finalize to avoid blocking shutdown    }  }  return GameSnapshotSchema.parse(next) as GameSnapshot;}
