# `docs/tasks/0008-turn-structure-and-cleanup-temp-files.md`

## Title

Turn structure enforcement: *place → (optional action) → pass* and automatic cleanup of obsolete temp files

## Goal

Implement strict turn sequencing in the core engine:

1. On your turn, you **must place exactly one tile** from your hand.
2. After placing, you **may perform exactly one additional action** (draw/place from other actions, expansions later).
3. Then you **must end your turn** (`core.passTurn`).

Additionally:
Whenever Codex generates or updates files during this task, ensure that **all temporary or intermediate files that are no longer used are deleted**.

This task codifies a central gameplay invariant: one tile placement per turn.

---

## Non-negotiables

* **English-only identifiers**.
* **Comments are mandatory**, especially around sequencing invariants.
* **Update `CHANGELOG.md`**.
* **Delete unused temp files generated by Codex** (explicit).
* Deterministic core behavior.
* Server authoritative.

---

## Sequencing model (must be explicit)

Add explicit turn phases in state:

* `phase: "awaitingPlacement" | "awaitingAction" | "awaitingPass"`
  (alternatively a numeric enum with comments)

Rules:

* A new turn always starts at `"awaitingPlacement"`.
* After a successful `core.placeTile`, change phase → `"awaitingAction"`.
* Allow exactly one **other** non-placement core action in `"awaitingAction"` (e.g., draw, later expansions).
* After that, enforce phase → `"awaitingPass"` and require `core.passTurn` to end turn.
* Reject invalid actions based on current phase with structured error codes:

  * `WRONG_TURN_PHASE`
  * `PLACEMENT_ALREADY_DONE`
  * `ACTION_NOT_ALLOWED_IN_PHASE`

Add comments explaining the invariant.

---

## Deliverables

### A) Core: Turn phase primitives

In `packages/core`, extend `GameState`:

* `phase` field as defined above
* enforce the turn lifecycle in `applyAction`

Modify `core.passTurn`:

* only allowed in `"awaitingPass"`
* resets phase to `"awaitingPlacement"` for next turn

Modify `core.placeTile`:

* only allowed in `"awaitingPlacement"`

Modify other core actions:

* only allowed in `"awaitingAction"` (reject in other phases)

Add comments explaining why these checks exist.

---

### B) Core: new errors for phase enforcement

Add errors:

* `WRONG_TURN_PHASE`
* `PLACEMENT_ALREADY_DONE`
* `ACTION_NOT_ALLOWED_IN_PHASE`

Ensure they are machine-readable and can be displayed in the client debug UI.

---

### C) State snapshot changes

Snapshot must expose:

* `turn`
* `activePlayerId`
* `phase`

Client must reflect current phase visually (debug panel is sufficient).

---

### D) Server: authoritative enforcement

The server must enforce the above phases strictly:

* reject invalid action with appropriate error code
* do not advance turn automatically unless `core.passTurn` succeeds

Add server tests for:

* placement allowed only in correct phase
* other actions only in `"awaitingAction"`
* pass only in `"awaitingPass"`

---

### E) Client: UI flow updates

In the client debug UI:

* Show current phase string
* Disable/enable buttons based on phase

  * “Place tile” only in `"awaitingPlacement"`
  * “Draw tile” (or other actions) only in `"awaitingAction"`
  * “Pass turn” only in `"awaitingPass"`

Add comments in UI code where sequencing logic is reflected.

---

### F) Cleanup temp files (your explicit addition)

**IMPORTANT:**
When generating code for this task, Codex must remove any temporary files or boilerplate that were created in previous generation steps and are **no longer used** (e.g., unused mocks, intermediate test files, placeholder configs, stale helpers).

To enforce this:

* In the prompt to Codex (task opening instructions), include:

  > *Identify and delete any temporary files that were created during code generation or scaffolding and are no longer referenced anywhere in the project.*

Codex must:

1. Analyze file references
2. Remove unused files
3. Update imports/tests accordingly
4. Document file removals in the task report

Example of temp files to clean up (if present):

* placeholder files like `temp_*.ts`
* generated mocks that are not used
* scratch files (`example_*`, `dummy_*`)
* old test sandboxes not referenced

Codex must not delete valid source code.

Add a note in the changelog about the cleanup.

---

### G) Tests

Add tests in `packages/core`:

* Phase enforcement:

  * cannot place after placement done
  * cannot draw/other actions before placement
  * only one extra action allowed
  * must pass turn only in correct phase

Ensure server tests mirror these.

---

### H) Changelog update (MANDATORY)

Append dated entry:

* Added turn sequencing phases (`awaitingPlacement`, `awaitingAction`, `awaitingPass`)
* Enforced placement → action → pass invariants
* Cleaned up unused temp files and intermediates

Document which files were removed.

Do not rewrite previous entries.

---

## Acceptance criteria

* `pnpm dev`, `pnpm -r build/test/lint` all pass
* Client UI reflects phase
* Turn sequencing enforced by server
* Temp files removed
* Comments document invariants
* No German identifiers

---

## Explicitly do NOT do

* Do not implement adjacency, scoring, or board rules beyond placement phase.
* Do not add expansions.
* Do not introduce new UI patterns beyond debug flow.

---

## Output requirements (Codex must report)

1. Summary
2. Files touched/removed
3. Manual verification steps
4. Exact commands

---

Summary

Implemented strict turn phases in core: awaitingPlacement → awaitingAction → awaitingPass, and enforced the invariant “place exactly one tile, optionally one other action, then pass”.
Added phase field to snapshot state and mirrored activePlayerId for convenience.
Updated core actions:
core.placeTile: allowed only in awaitingPlacement; transitions to awaitingAction.
core.drawTile: allowed only in awaitingAction; transitions to awaitingPass.
core.passTurn: allowed only in awaitingPass; advances active player, increments turn, and resets phase to awaitingPlacement.
Added new machine-readable errors: WRONG_TURN_PHASE, PLACEMENT_ALREADY_DONE, ACTION_NOT_ALLOWED_IN_PHASE.
Deterministic initial hand: on session creation, core deals 1 tile to each player from supply to allow first-turn placement.
Client debug UI shows current phase and activePlayerId, and disables/enables Place/Draw/Pass buttons based on phase.
Server remains pass-through/authoritative; added server-side tests for phase enforcement and updated placement test for initial-hand flow.
Cleaned up temp files: removed tmp_edit_engine.ts and temp_proto_debug.txt.
All core tests updated for new sequencing; server tests green; lint and build pass.
Files Touched/Removed

Updated
packages/core/src/protocol/index.ts
Added phase schema, optional activePlayerId, and new error codes.
packages/core/src/expansion/engine.ts
Phase enforcement in applyAction; initial hands dealt in createInitialSnapshot; comments added.
packages/core/src/engine.ts
Stub state updated with phase and activePlayerId to satisfy schema.
packages/core/src/board.test.ts
Adjusted for turn phases (occupied cell tested across turn); simplified to three tests.
packages/core/src/supply.test.ts
Adjusted for turn phases; added deterministic errors with correct phase; removed brittle flows.
packages/core/src/turn.test.ts
Updated pass-turn test to place → draw → pass per player.
packages/core/src/phase.test.ts
New test for basic phase enforcement.
apps/server/src/phase.test.ts
New server test validating phase errors on wrong-phase actions.
apps/server/src/placement.test.ts
Uses initial hand; removed pre-place draw.
apps/client/src/App.tsx
Shows phase and activePlayerId; buttons gated by phase; typed snapshot reads; minimized any usage.
apps/server/package.json
(earlier) Scoped tests to src to avoid dist duplicates.
apps/server/tsconfig.json
(earlier) Excluded dist/ and test files from build.
eslint.config.js
(earlier) Test-only rule relaxer; ensured lint passes after changes.
CHANGELOG.md
Added dated entry describing phases, enforcement, client UI, server tests, and cleanup of temp files.
Added
packages/core/src/phase.test.ts
apps/server/src/phase.test.ts
docs/tasks/0008-turn-structure-and-cleanup-temp-files.md (task record)
Removed (cleanup)
tmp_edit_engine.ts
temp_proto_debug.txt
Manual Verification Steps

Install and build
pnpm install
pnpm -r build
Run tests and lint
pnpm -r test
pnpm -r lint
Run dev (two terminals)
Terminal A: pnpm --filter @bc/server dev
Terminal B: pnpm --filter @bc/client dev
In the client:
Click “Create session”.
Confirm phase shows “awaitingPlacement”, and activePlayerId is the first player.
Place tile: select from Active hand, set q=0,r=0, click “Place tile”. Phase becomes “awaitingAction”; board lists the new cell.
Draw tile: click “Draw tile”. Phase becomes “awaitingPass”.
Pass turn: click “Pass turn”. Active player advances; turn increments; phase returns to “awaitingPlacement”.
Try to draw before placing on a new turn → error (ACTION_NOT_ALLOWED_IN_PHASE).
Try to pass before drawing after a placement → error (WRONG_TURN_PHASE).
Try to place again in the same turn → error (PLACEMENT_ALREADY_DONE).
Server behavior:
Ensure Socket.IO errors mirror codes from core for wrong-phase attempts.
POST /api/session returns sessionId; first snapshot includes config.seed and hands (each with 1 tile).
Exact Commands

Install/build/test/lint
pnpm install
pnpm -r build
pnpm -r test
pnpm -r lint
Dev servers
pnpm --filter @bc/server dev
pnpm --filter @bc/client dev
Full preview (optional)
pnpm preview:full
Notes and rationale:

Turn phases are enforced in core (single source of truth). Server only validates envelopes and broadcasts results; it does not override phases or advance turns.
Initial tile deal ensures turn 1 is playable given new sequencing (place must come before draw). This is documented in engine comments.
Client intentionally remains a minimal debug surface; no new UX beyond phase indicators and disabled controls.
Cleanups: Removed tmp_edit_engine.ts (local scratch) and temp_proto_debug.txt (throwaway transcript) to keep repo tidy; recorded in CHANGELOG.
